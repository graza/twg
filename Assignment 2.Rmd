---
title: "CT5104 Assignment 2"
author: 
  - "Graham Agnew (Student number 06120661)"
  - "Raghu (Student number )"
date: "25-February-2017"
output: 
  pdf_document: 
    fig_caption: yes
subtitle: MSc Data Analytics - Part Time (GYE07)
---

## Introduction

In this assignment, web datasets have been produced from Wikipedia using the `scrapy` Python module.  In order that a sufficiently small subset of Wikipedia could be used, the `scrapy` spider has been designed to work from a category page, and work its way down through the tree of sub-categories fetching the pages linked to the category and sub-categories along the way.

## Spider

Category pages in Wikipedia are formed with a URL of the following form:

`http://en.wikipedia.org/wiki/Category:<category>`

The name of the category is substituted for `<category>`.  The MediaWiki content management system that is used to run Wikipedia builds the body of the page with a `<div>` tag with an id attribute equal to `mw-subcategories` plus a `<div>` tag with an id equal to `mw-pages`.

When spidering a category the `parse` method for the category page will iterate through the links in the subcategory section, yielding a new `Request` and effectively recursing back into itself.  It will also iterate through the page links and yield a new `Request` that will use `parse_page` to process the content pages.  The category to use as a starting point can be passed into the spider.

The `parse_page` method iterates through the links found in the `mw-content-text` page element.  These links are filtered such that only links to other wiki pages are included and loops are removed, as are links to "meta" information (e.g. other category pages or help pages).  The end result of processing a page is a Python `dict` that includes the page, a list of pages that it links to, plus a list external domains that it links to.

The output can be in different formats, JSON being a relatively compact form that is convenient for subsequent processing steps.  The R implementation of `igraph` has been used to produce this report, and as such it reads the data sets from file, rather than having them embedded in the report.

It has been found that the pages linked by the category tree link to many other pages outside the category tree.  These other pages are not represented in the graphs below.  Instead only links within the pages of the category are included.

## Algebraists Category

The following graph shows the pages under the "Algebraists" category on Wikipedia.  This category includes four subcategories and rougly four hundred and fifty pages in total.  

### Graph

The graph of the pages is seen here below.  In this graph the size of the nodes reflects the log of the total degree of the node.  For the sake of readability, no arrows are shown for the graph even though it is directed.

```{r, echo=FALSE, results='hide', message=FALSE}
library(ggplot2)
library(igraph)
library(RJSONIO)

filename <- file.path('twg', 'yyy.json')
json <- fromJSON(filename) #, encoding = "utf-8")
page_names <- names(json)
g <- make_empty_graph(directed = TRUE) %>% add_vertices(length(page_names), name = page_names)
i <- 1
for (p in page_names) {
  for (t in json[[p]]) {
    j <- (1:length(page_names))[page_names == t]
    g <- add_edges(g, c(i, j))
  }
  i <- i + 1
}
V(g)$size <- sapply(degree(g), function(x) ifelse(x<2, 0.5, log(x)))*2
par(mai=c(0,0,1,0))
#plot(g, vertex.size=1)
plot(g, layout=layout.fruchterman.reingold,	
     main='Wikipedia category map',
     #vertex.label.dist=0.5,			#puts the name labels slightly off the dots
     vertex.frame.color='blue', 		#the color of the border of the dots 
     vertex.label.color='black',		#the color of the name labels
     vertex.label.font=2,			#the font of the name labels
     #vertex.label=V(g)$name,		#specifies the lables of the vertices. in this case the 'name' attribute is used
     vertex.label=NA,
     edge.arrow.size=0.2,
     vertex.label.cex=1			#specifies the size of the font of the labels. can also be made to vary
)
```

It is noted that there are many pages with no links to any others within this category.  These can be seen in the semi-circle of disconnected nodes around the perimeter.  Even with this small number of nodes we can see the graph starting to exhibit some of the classic bowtie shape seen in the internet.

### Degree Distribution

```{r, echo=FALSE}
d_out_tab <- table(degree(g, mode = "out"))
d_out <- data.frame(d_out_tab)
d_out <- cbind(d_out, d_out=as.numeric(names(d_out_tab)))

d_in_tab <- table(degree(g, mode = "in"))
d_in <- data.frame(d_in_tab)
d_in <- cbind(d_in, d_in=as.numeric(names(d_in_tab)))

ggplot() + theme_bw() +
  geom_point(data = d_out, aes(d_out,Freq)) +
  geom_point(data = d_in, aes(d_in,Freq), colour="red") +
  scale_x_log10() + scale_y_log10() + xlab("Degree")
```

|$N$|$L$|$\left \langle k^{in} \right \rangle$|$\left \langle k^{out} \right \rangle$|$\left \langle k^{total} \right \rangle$|$\overline{C}$|$\left \langle d \right \rangle$|$\frac{\log N}{\log \left \langle k \right \rangle}$
|:---:|:----:|:------:|:------:|:------:|:------:|:------:|:------:|
`r length(V(g))`|`r length(E(g))`|`r mean(degree(g, mode = "in"))`|`r mean(degree(g, mode = "out"))`|`r mean(degree(g, mode = "total"))`|`r transitivity(g)`|`r mean_distance(g, directed = FALSE)`|`r log(length(V(g)))/log(mean(degree(g, mode = "total")))`

## Comparison with small world model

```{r, echo=FALSE}
beta <- 1 - (transitivity(g)/transitivity(sample_smallworld(1,length(V(g)),2,0)))^(1/3)
sw <- sample_smallworld(1, length(V(g)), 2, beta)
```

We compare the graph found through web mining with the small world model.  The value for the rewiring probability was derived using the following formula:

$$\beta = 1 - \sqrt[3]{\frac{C(\beta)}{C(0)}}$$

Where $C(\beta)$ is set to the clustering coefficient of the mined graph.  This yields a rewiring probability of about 13.4%.  The following table shows the values for the average path length and the clustering coefficient for both the mined graph and the small world model.  The differences here can probably be accounted for by the disconnected nodes in the mined graph.

|Value|Mined Network|Small World Network|
|:------:|:------:|:------:|
$\left \langle d \right \rangle$|`r mean_distance(g, directed = FALSE)`|`r mean_distance(sw, directed = FALSE)`|
$\overline{C}$|`r transitivity(g)`|`r transitivity(sw)`|

